/**
 * Copyright 2010 by Anadan. All rights reserved.
 * @author Anadan (aaafwd@gmail.com)
 */

function x(){this.a=new l;this.q=this.h=null;this.G=0;this.s=new ba}function y(a,b){if(b&&b.selected)a.h=b}function ca(a,b){a.h&&a.h.windowId==b.windowId&&a.h.index+1<b.index&&t(a.a,"aaa.pweb.tabopen")&&chrome.tabs.move(b.id,{windowId:b.windowId,index:a.h.index+1},function(c){y(a,c)});y(a,b)}
function A(a,b){if(!a.q||a.G!=u(a.a)){a.q=[];a.G=u(a.a);for(var c=v(a.a)||[],e=0,g;g=c[e];++e)if(g.enabled&&g.urlRegex){var i;try{i=new RegExp(g.urlRegex,"i")}catch(d){}var f;try{f=g.urlExcludeRegex&&new RegExp(g.urlExcludeRegex,"i")}catch(h){}if(i){g.urlRegex=i;g.urlExcludeRegex=f;a.q.push(g)}}}c={preserveDocWrite:true,filters:[],css:"",html:"",js:""};e=true;for(g=0;i=a.q[g];++g){f=i.urlExcludeRegex;if(i.urlRegex.test(b)&&(!f||!f.test(b))){e=false;i.preserveDocWrite||(c.preserveDocWrite=false);if(i.filters)c.filters=
c.filters.concat(i.filters);if(i.css)c.css+=i.css;if(i.html)c.html+=i.html;if(i.js)c.js+=i.js}}return e?null:c}
x.prototype.i=function(){var a=this;chrome.windows.getAll({populate:true},function(b){for(var c=0,e;e=b[c];++c)for(var g=0,i;i=e.tabs[g];++g)try{chrome.tabs.sendRequest(i.id,{})}catch(d){}});chrome.tabs.getSelected(null,function(b){y(a,b)});chrome.tabs.onSelectionChanged.addListener(function(b){chrome.tabs.get(b,function(c){y(a,c)})});chrome.tabs.onMoved.addListener(function(b){chrome.tabs.get(b,function(c){y(a,c)})});chrome.windows.onFocusChanged.addListener(function(b){chrome.tabs.getSelected(b,
function(c){y(a,c)})});chrome.tabs.onCreated.addListener(function(b){ca(a,b)});chrome.pageAction.onClicked.addListener(function(b){var c=a.s,e=b.id,g=0;for(var i in c.b)if(c.b[i]==2)delete c.b[i];else++g;if(g>10)c.b={};c.b[e]=1;chrome.tabs.update(b.id,{url:b.url})});chrome.tabs.onRemoved.addListener(function(b){delete a.s.b[b]});chrome.tabs.onUpdated.addListener(function(b,c,e){if(c.status=="loading"){chrome.pageAction.hide(e.id);b=a.s;c=e.id;if(b.b[c]==1){b.b[c]=2;b=true}else{delete b.b[c];b=false}if(b)chrome.tabs.sendRequest(e.id,
{disabled:true});else(b=A(a,e.url))&&chrome.tabs.sendRequest(e.id,{rule:b})}else chrome.tabs.sendRequest(e.id,{})});chrome.extension.onRequest.addListener(function(b,c,e){c=c.tab;if(b.modifiedEvent)m(a.a)&&chrome.pageAction.show(c.id);else if(!a.s.b[c.id])if(e){b=b.url&&A(a,b.url);e(b||null)}});chrome.extension.onRequestExternal.addListener(function(b,c,e){b&&b.pwebProviderRules&&e&&e()})};(new x).i();
