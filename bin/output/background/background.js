/**
 * Copyright 2010 by Anadan. All rights reserved.
 * @author Anadan (aaafwd@gmail.com)
 */

function x(){this.h=new l;this.q=this.g=null;this.G=0;this.s=new ba}function y(a,b){if(b&&b.selected)a.g=b}function ca(a,b){a.g&&a.g.windowId==b.windowId&&a.g.index+1<b.index&&t(a.h,"aaa.pweb.tabopen")&&chrome.tabs.move(b.id,{windowId:b.windowId,index:a.g.index+1},function(c){y(a,c)});y(a,b)}
function z(a,b){if(!a.q||a.G!=u(a.h)){a.q=[];a.G=u(a.h);for(var c=v(a.h)||[],e=0,g;g=c[e];++e)if(g.enabled&&g.urlRegex){var h;try{h=new RegExp(g.urlRegex,"i")}catch(d){}var f;try{f=g.urlExcludeRegex&&new RegExp(g.urlExcludeRegex,"i")}catch(i){}if(h){g.urlRegex=h;g.urlExcludeRegex=f;a.q.push(g)}}}c={preserveDocWrite:true,filters:[],css:"",html:"",js:""};e=true;for(g=0;h=a.q[g];++g){f=h.urlExcludeRegex;if(h.urlRegex.test(b)&&(!f||!f.test(b))){e=false;h.preserveDocWrite||(c.preserveDocWrite=false);if(h.filters)c.filters=
c.filters.concat(h.filters);if(h.css)c.css+=h.css;if(h.html)c.html+=h.html;if(h.js)c.js+=h.js}}return e?null:c}
x.prototype.i=function(){var a=this;chrome.windows.getAll({populate:true},function(b){for(var c=0,e;e=b[c];++c)for(var g=0,h;h=e.tabs[g];++g)try{chrome.tabs.sendRequest(h.id,{})}catch(d){}});chrome.tabs.getSelected(null,function(b){y(a,b)});chrome.tabs.onSelectionChanged.addListener(function(b){chrome.tabs.get(b,function(c){y(a,c)})});chrome.tabs.onMoved.addListener(function(b){chrome.tabs.get(b,function(c){y(a,c)})});chrome.windows.onFocusChanged.addListener(function(b){chrome.tabs.getSelected(b,
function(c){y(a,c)})});chrome.tabs.onCreated.addListener(function(b){ca(a,b)});chrome.pageAction.onClicked.addListener(function(b){var c=a.s,e=b.id,g=0;for(var h in c.a)if(c.a[h]==2)delete c.a[h];else++g;if(g>10)c.a={};c.a[e]=1;chrome.tabs.update(b.id,{url:b.url})});chrome.tabs.onRemoved.addListener(function(b){delete a.s.a[b]});chrome.tabs.onUpdated.addListener(function(b,c,e){if(c.status=="loading"){chrome.pageAction.hide(e.id);b=a.s;c=e.id;if(b.a[c]==1){b.a[c]=2;b=true}else{delete b.a[c];b=false}if(b)chrome.tabs.sendRequest(e.id,
{disabled:true});else(b=z(a,e.url))&&chrome.tabs.sendRequest(e.id,{rule:b})}else chrome.tabs.sendRequest(e.id,{})});chrome.extension.onRequest.addListener(function(b,c,e){c=c.tab;if(b.modifiedEvent)p(a.h)&&chrome.pageAction.show(c.id);else if(!a.s.a[c.id])if(e){b=b.url&&z(a,b.url);e(b||null)}});chrome.extension.onRequestExternal.addListener(function(b,c,e){b&&b.pwebProviderRules&&e&&e()})};(new x).i();
