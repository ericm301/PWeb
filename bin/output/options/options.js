/**
 * Copyright 2010 by Anadan. All rights reserved.
 * @author Anadan (aaafwd@gmail.com)
 */

var P=new l;function da(){var a=B("tab-open");w(P,"aaa.pweb.tabopen",!!a.checked);a=B("show-page-action");w(P,"aaa.pweb.show_page_action",!!a.checked)}window.save_preferences=da;function ea(){B("tab-open").checked=!!!!t(P,"aaa.pweb.tabopen");B("show-page-action").checked=!!p(P)}window.restore_preferences=ea;function Q(){this.e=true;this.b=null;R(this,true);fa(this)}
function fa(a){var b=B("rules-container"),c=B("rule-template");B("add-new-rule").addEventListener("click",function(){var e=F(c);S(a,e,{enabled:true,urlRegex:"^http://"});b.appendChild(e);R(a,false);L(e,"collapsed");K(e,"expanded");window.scrollTo(0,e.offsetTop);C("input-rule-name",e)[0].select()},true);B("save-changes").addEventListener("click",function(){T(a)},true);B("dump-rules").addEventListener("click",function(){U(a,G("should_save_changes"))&&V(a,v(P))},true);B("load-dumped-rules").addEventListener("click",
function(){if(U(a,G("should_save_changes"))){V(a,null);var e=prompt(G("enter_dump_prompt"),"");if(e){var g;try{g=typeof e=="string"?JSON.parse(e):e}catch(h){alert(G("error_json_parse",""+h))}if(g){e=v(P);e=e.concat(g);a.display(e);R(a,false)}}}},true);b.addEventListener("change",function(){R(a,false)},true);window.addEventListener("keydown",function(e){var g=e.keyCode;if(g==8||g==13||g==45||g==46||e.ctrlKey&&(g==67||g==86||g==88||g==90))window.setTimeout(function(){ga(a,e.target);R(a,false)},0);else if(g==
27){V(a,null);a.b=null;W(a)}},true);window.addEventListener("keydown",function(e){if(a.e){e=e.target&&e.target.tagName;if(e=="INPUT"||e=="TEXTAREA")window.setTimeout(function(){R(a,false)},0)}},false);window.addEventListener("click",function(e){a:{for(var g=B("popup-menu"),h,d=e&&e.target;d;d=d.parentNode){if(d==g)if(ha(a,e.target.id)){h=null;break}else break a;if(M(d,"rule-options")){h=d;break}}if(h==a.b)h=null;a.b=h;W(a)}g=e.target;h=N(g,["rule-expander","rule-header"]);if(!h)for(d=g;d;d=d.parentNode)if(M(d,
"rule-expander")){h=true;break}if(h){g=X(a,g);h=J(g);for(d=0;d<h.length;d++)if(h[d]=="expanded")h[d]="collapsed";else if(h[d]=="collapsed")h[d]="expanded";g.className=h.join(" ");g=g.getElementsByTagName("TEXTAREA");for(h=0;d=g[h];++h)ga(a,d)}g=e.target;if(M(g,"add-new-filter")){g=C("filters-container",X(a,g))[0];h=B("filter-template");h=F(h);ia(a,h,{});g.appendChild(h)}e=e.target;M(e,"rule-enabled")&&Y(a,X(a,e))},true);window.addEventListener("resize",function(){a.b=null;W(a)},true)}
Q.prototype.display=function(a,b){var c=B("rules-container"),e=B("rule-template");D(c);for(var g=0,h;h=a[g];++g){var d=F(e);S(this,d,h);g||ja(this,d,true);c.appendChild(d)}b&&Z(this)};function V(a,b){a=B("dump-rules-output");if(b){b=JSON.stringify(b).replace(/  /g," \\u0020");a.value=b;a.style.display="";a.select()}else a.style.display="none"}
function T(a){var b=Z(a),c=P;w(c,"aaa.pweb.filters",b);w(c,"aaa.pweb.filters_update_time",Date.now());for(b=B("rules-container").firstChild;b;b=b.nextSibling)ka(a,b);R(a,true)}function Z(a){var b=[];B("errors").innerHTML="";for(var c=B("rules-container").firstChild;c;c=c.nextSibling){var e=la(a,c);b.push(e)}return b}
function la(a,b){var c={},e=C("input-rule-name",b)[0];c.name=e.value||G("rule_name_noname");e=C("input-url-pattern",b)[0];c.urlRegex=e.value;c.urlRegex?$(a,c.urlRegex,G("error_invalid_match_regex",c.name)):ma(a,G("error_empty_match_regex",c.name));e=C("input-url-exclude",b)[0];c.urlExcludeRegex=e.value;$(a,c.urlExcludeRegex,G("error_invalid_exclude_regex",c.name));e=C("rule-enabled",b)[0];c.enabled=!!e.checked;e=C("intercept-doc-write",b)[0];c.preserveDocWrite=!e.checked;e=C("rule-css",b)[0];c.css=
e.value;e=C("rule-html",b)[0];c.html=e.value;e=C("rule-js",b)[0];c.js=e.value;e=[];for(b=C("filters-container",b)[0].firstChild;b;b=b.nextSibling){var g={},h=C("filter-tags",b)[0];g.tags=h.value;h=C("filter-attr",b)[0];g.attribute=h.value;h=C("filter-value",b)[0];g.value=h.value;h=C("filter-value-regex",b)[0];g.valueRegex=h.value;$(a,g.valueRegex,G("error_invalid_remover_regex",[c.name,e.length+1]));h=true;for(var d in g)if(g[d]){h=false;break}h||e.push(g)}c.filters=e;return c}
function $(a,b,c){try{a.X=new RegExp(b,"i")}catch(e){ma(a,c+": "+b)}}function ma(a,b){B("errors").innerHTML+=b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;")+"<br>"}
function S(a,b,c){b.removeAttribute("id");b.style.display="";C("input-rule-name",b)[0].value=c.name||G("rule_name_noname");C("input-url-pattern",b)[0].value=c.urlRegex||"";C("input-url-exclude",b)[0].value=c.urlExcludeRegex||"";C("rule-enabled",b)[0].checked=!!c.enabled;C("intercept-doc-write",b)[0].checked=!c.preserveDocWrite;for(var e=C("filters-container",b)[0],g=B("filter-template"),h=0,d;d=c.filters&&c.filters[h];++h){var f=F(g);ia(a,f,d);e.appendChild(f)}C("rule-css",b)[0].value=c.css||"";C("rule-html",
b)[0].value=c.html||"";C("rule-js",b)[0].value=c.js||"";ka(a,b);Y(a,b)}function ka(a,b){a=C("input-rule-name",b)[0];var c=C("rule-name",b)[0];E(c,a.value);a=C("input-url-pattern",b)[0];b=C("rule-url-pattern",b)[0];E(b,a.value)}
function ja(a,b,c){c?K(b,"adblocker"):L(b,"adblocker");for(var e=["INPUT","TEXTAREA"],g=0,h;h=e[g];++g){h=b.getElementsByTagName(h);for(var d=0,f;f=h[d];++d)if(!N(f,["input-url-pattern","input-url-exclude"])){O(f,"readonly",c);f.type=="checkbox"&&!M(f,"rule-enabled")&&O(f,"disabled",c)}}Y(a,b)}function Y(a,b){!C("rule-enabled",b)[0].checked?K(b,"disabled"):L(b,"disabled")}
function ia(a,b,c){b.removeAttribute("id");b.style.display="";C("filter-tags",b)[0].value=c.tags||"";C("filter-attr",b)[0].value=c.attribute||"";C("filter-value",b)[0].value=c.value||"";C("filter-value-regex",b)[0].value=c.valueRegex||""}function ga(a,b){if(!(!b||b.tagName!="TEXTAREA"||!N(b,["rule-css","rule-js","rule-html"])))if(b.value){a=Math.max(80,b.scrollHeight-4);a=Math.min(a,1200);b.style.height=a>80?a+"px":""}else b.style.height=""}
function X(a,b){for(;b;b=b.parentNode)if(N(b,["rule-template","filter"]))return b;return null}
function ha(a,b){var c=X(a,a.b),e=c.parentNode;if(b=="menu-move-up"){(b=c.previousSibling)&&!M(b,"adblocker")&&e.insertBefore(c,b);R(a,false)}else if(b=="menu-move-down"){(b=c.nextSibling)&&e.insertBefore(c,b.nextSibling);R(a,false)}else if(b=="menu-dump"){V(a,la(a,c));return true}else if(b=="menu-clone"){b=F(c);e.insertBefore(b,c.nextSibling);M(b,"adblocker")&&ja(a,b,false);R(a,false);return true}else if(b=="menu-delete"){e.removeChild(c);R(a,false);return true}return false}
function W(a){var b=B("popup-menu");if(a.b){b.style.display="";var c=X(a,a.b);b.className=M(c,"adblocker")?"adblocker":c.parentNode==B("rules-container")?"rule":"filter";a=a.b.getBoundingClientRect();c=b.getBoundingClientRect();b.style.top=window.scrollY+a.bottom+"px";b.style.left=Math.max(0,window.scrollX+a.right-c.width)+"px"}else b.style.display="none"}function U(a,b){if(!a.e){(b=confirm(b||G("save_changes")))&&T(a);return b}return true}
function R(a,b){if(!b){var c=v(P),e=Z(a);if(c.length==e.length&&JSON.stringify(c)==JSON.stringify(e))b=true}a.e=b;O(B("save-changes"),"disabled",a.e);if(!a.e)B("dump-rules-output").style.display="none"}(function(){var a=new Q;a.display(v(P),true);window.onbeforeunload=function(){if(!a.e)return G("discard_changes")}})();
